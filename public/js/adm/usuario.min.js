var v_id_usuario_acceso,v_id_perfil,v_id_acceso=var_tribunal=0;var var_p="";var mostrardatos=function(a){if(a.usuario[0].urlimage!=null){if(a.usuario[0].urlimage.length>1){$(".foto-perfil").attr("src",a.usuario[0].urlimage)+"?"+Math.random();
}}$("#nombre").val(a.usuario[0].name);$("#id_usuario").val(a.usuario[0].user_id);$("#activo").prop("checked",a.usuario[0].activo);destruirTabla("TablaPerfil");
actualizarDatos(a.TablaUsuarioPerfil);};var procesarajax=function(c,b,a){$.ajax({url:b,headers:{"X-CSRF-TOKEN":$("input[name=_token]").val()},type:"POST",async:false,dataType:"JSON",data:c,}).done(function(d){switch(a){case 3:mensajesAlerta("Procesado!","Se procesó con éxito.","info");
break;case 2:case 4:mensajesAlerta("Procesado!","Se procesó con éxito.","info");mostrardatos(d);break;case 5:$("#id_poder").select2({placeholder:"Seleccione...",language:"es",width:"100%",});
destruirTabla("TablaAcceso");TablaAccesos(d.acceso);$("#id_modulo").select2({placeholder:"Seleccione...",language:"es",allowClear:true,width:"100%",data:d.moduloscombo,}).on("change",function(g){var f=$("#TablaAcceso").dataTable();
if($("#id_modulo").val()){procesarajax({id_tipo_modulo_id_modulo:$("#id_modulo").val()},datos.rutafiltrarpoder,6);f.fnFilter("^"+$("#id_modulo").val()+"$",3,true);
}else{$("#id_poder").empty();f.fnFilter("",3,true);}$("#id_poder").val(null).trigger("change");});break;case 6:$("#id_poder").empty();$("#id_poder").select2({placeholder:"Seleccione...",data:d,language:"es"});
break;case 7:destruirTabla("TablaAcceso");TablaAccesos(d);$(".combo").val(null).trigger("change");mensajesAlerta("Procesado!","Se procesó con éxito.","info");
break;default:mostrardatos(d);}}).fail(function(e,d){var f="";if(e.status===0){f="Not connect.\n Verify Network.";}else{if(e.status==422){}else{if(e.status==404){f="Requested page not found. [404]";
}else{if(e.status==500){f="Internal Server Error [500]. Si el error persiste comuníquese con informática.";}else{if(d==="parsererror"){f="Requested JSON parse failed.";
}else{if(d==="timeout"){f="Time out error.";}else{if(d==="abort"){f="Ajax request aborted.";}else{f="Uncaught Error.\n"+e.responseText;}}}}}}}mensajesAlerta("Error",f,"error");
});};var TablaAccesos=function(a){$("#TablaAcceso").dataTable({aLengthMenu:[[4,10,-1],[4,10,"All"]],language:lenguajeTabla,data:a,columns:[{title:"Módulo",data:"des_cod_modulo"},{title:"Poder",data:"des_poder"},{title:"id_acceso",data:"id_acceso",visible:0},{title:"id_tipo_modulo_id_modulo",data:"id_tipo_modulo_id_modulo",visible:0},{title:"id_poder",data:"id_poder",visible:0}],paging:false});
menuC("TablaAcceso");};var actualizarDatos=function(a){$("#TablaPerfil").dataTable({aLengthMenu:[[4,10,-1],[4,10,"All"]],language:lenguajeTabla,data:a,columns:[{title:"Sede",data:"des_sede"},{title:"Perfil",data:"des_nivel"},{title:"Estado",data:"des_estado"},{title:"Estatus",data:"activo_usuario_acceso"},{title:"id_usuario_acceso",data:"id_usuario_acceso",visible:0},{title:"id_sede",data:"id_sede",visible:0},{title:"id_nivel",data:"id_nivel",visible:0},],paging:false,fnCreatedRow:function(b,d,c){if(d.activo_usuario_acceso){$("td:eq(3)",b).html("Activo");
}else{$("td:eq(3)",b).html("Inactivo");}},});menuC("TablaPerfil");};var buscarusuario=function(a){procesarajax({rut:a},datos.rutabuscarusuario,1);};var destruirTabla=function(a){if($("#"+a).dataTable()){$("#"+a).dataTable().fnClearTable();
$("#"+a).dataTable().fnDraw();$("#"+a).dataTable().fnDestroy();}};var limpiar=function(){$(".foto-perfil").attr("src","/img/foto.png")+"?"+Math.random();
destruirTabla("TablaPerfil");actualizarDatos(null);$(".sel").val(null).trigger("change");$("#nombre").val("");$("#activo").prop("checked",false);$("#id_usuario").val("");
$("#rut").off("keypress");};var menuC=function(a){if(TablaNroRegistro(a)>0){$("#"+a+" tbody tr").bind("contextmenu",function(c){c.preventDefault();var b=TablaTraerCampo(a,this);
FilMenuContextual(b,a);if(a=="TablaPerfil"){v_id_usuario_acceso=b.id_usuario_acceso;v_id_perfil=b.id_nivel;}else{v_id_acceso=b.id_acceso;}if(TablaNroRegistro(a)>0){$("#mm").menu("show",{left:c.pageX,top:c.pageY});
}});}};var FilMenuContextual=function(a,b){if(b=="TablaPerfil"){$("#mm").menu("hideItem",$("#del_acceso")[0]);$("#mm").menu("showItem",$("#M_AccesoAvanzado")[0]);
$("#mm").menu("showItem",$("#Act_Plantilla")[0]);if(a.activo_usuario_acceso){$("#mm").menu("hideItem",$("#p_activo")[0]);$("#mm").menu("showItem",$("#p_inactivo")[0]);
}else{$("#mm").menu("showItem",$("#p_activo")[0]);$("#mm").menu("hideItem",$("#p_inactivo")[0]);}}else{$("#mm").menu("showItem",$("#del_acceso")[0]);$("#mm").menu("hideItem",$("#M_AccesoAvanzado")[0]);
$("#mm").menu("hideItem",$("#Act_Plantilla")[0]);$("#mm").menu("hideItem",$("#p_activo")[0]);$("#mm").menu("hideItem",$("#p_inactivo")[0]);}};function agregarRol(){$("#formusuario").formValidation("validate");
}var Procesoactivo=function(){if($("#id_usuario").val()){$.messager.confirm("Confirmación","Seguro desea "+(($("#activo").prop("checked"))?"activar":"desactivar")+" este usuario",function(a){if(a){procesarajax({id_usuario:$("#id_usuario").val(),estatus:$("#activo").prop("checked")},datos.rutaestatususuario,2);
}else{$("#activo").prop("checked",(!$("#activo").prop("checked")));}});}};var EstatusPerfil=function(a){procesarajax({id_usuario_acceso:v_id_usuario_acceso,estatus:a,id_usuario:$("#id_usuario").val()},datos.rutaestatuusuarioperfil,2);
};var validarUsuarioPerfil=function(d,c,b){var a=$("#TablaPerfil").dataTable();var e=0;if(d&&c&&b){$(a.fnGetNodes()).each(function(h){var f=a.fnGetPosition(this);
var g=a.fnGetData(f[0]);if(g[h]["id_sede"]==d&&g[h]["id_nivel"]==c){e=1;}});}switch(e){case 1:return{valid:false,message:"Verifique; ya posee el perfil es esa sede"};
default:return true;}};var ActualizarPlantilla=function(){$.messager.confirm("Confirmación","Seguro desea desea actualizar con la plantilla",function(a){if(a){procesarajax({id_usuario_acceso:v_id_usuario_acceso,id_perfil:v_id_perfil},datos.rutaactualizarplantilla,3);
}});};var formAccesoAvanzado=function(){procesarajax({id_usuario_acceso:v_id_usuario_acceso},datos.rutaaccesoavanzado,5);$("#w").window("open");AjustarTabla("TablaAcceso");
$("#id_modulo").val(null).trigger("change");$("#id_poder").val(null).trigger("change");};var AgregarAcceso=function(){$("#formmodulospoderes").formValidation("validate");
};var DelAcceso=function(){procesarajax({id_acceso:v_id_acceso,id_usuario_acceso:v_id_usuario_acceso},datos.rutaEliminarAcceso,7);};var consultarUsuario=function(){$("#formbuscarsuario").formValidation("validate");
};$(document).ready(function(){actualizarDatos(null);$("#id_sede").select2({placeholder:"Seleccione Sede",allowClear:true,}).on("change",function(d){$("#txtSedeCombo").val(($("#id_sede").val().length>0)?$("#id_sede").val():0);
});$("#id_perfil").select2({placeholder:"Seleccione Perfil",allowClear:true,}).on("change",function(d){$("#txtPerfilCombo").val(($("#id_perfil").val().length>0)?$("#id_perfil").val():0);
});var c=$("#formbuscarsuario").formValidation({message:"El módulo le falta un campo para ser completado",fields:{rut:{verbose:false,validators:{notEmpty:{message:"El campo es requerido"},stringLength:{min:3,message:"El rut debe tener más de 3 caracteres."},}}}}).on("success.form.fv",function(d){buscarusuario($("#rut").val());
$("#rut").on("keypress",function(f){limpiar();});}).on("status.field.fv",function(f,d){d.element.parents(".form-group").removeClass("has-success");d.fv.disableSubmitButtons(true);
});var a=$("#formmodulospoderes").formValidation({message:"Debe seleccionar",fields:{id_modulo:{verbose:false,validators:{notEmpty:{message:"El campo es requerido"},}},"id_poder[]":{verbose:false,validators:{choice:{min:1,message:"Por favor seleccione %s, como mínimo"},callback:{callback:function(g,e,f){var h=e.getFieldElements("id_modulo").val();
var d=f.val();return b(h,d);}}}}}}).on("success.form.fv",function(d){procesarajax({id_usuario_acceso:v_id_usuario_acceso,id_tipo_modulo_id_modulo:$("#id_modulo").val(),id_poder:$("#id_poder").val(),},datos.rutaAgregarAcceso,7);
}).on("status.field.fv",function(f,d){d.element.parents(".form-group").removeClass("has-success");d.fv.disableSubmitButtons(true);});var a=$("#formusuario").formValidation({excluded:[":disabled"],message:"Debe buscar un usuario",fields:{id_sede:{verbose:false,validators:{notEmpty:{message:"El campo es requerido"},callback:{callback:function(f,d,e){if($("#id_usuario").val().length==0){$("#id_sede").val(null).trigger("change");
return{valid:false,message:"Verifique debe seleccionar un usuario."};}return validarUsuarioPerfil($("#id_sede").val(),$("#id_perfil").val(),$("#id_tribunal").val());
}}}},id_perfil:{verbose:false,validators:{notEmpty:{message:"El campo es requerido"},callback:{callback:function(f,d,e){if($("#id_usuario").val().length==0){$("#id_perfil").val(null).trigger("change");
return{valid:false,message:"Verifique debe seleccionar un usuario."};}return validarUsuarioPerfil($("#id_sede").val(),$("#id_perfil").val(),$("#id_tribunal").val());
}}}},}}).on("success.form.fv",function(d){procesarajax({id_usuario:$("#id_usuario").val(),id_sede:$("#id_sede").val(),id_perfil:$("#id_perfil").val(),},datos.rutaasignarperfil,4);
}).on("status.field.fv",function(f,d){d.element.parents(".form-group").removeClass("has-success");d.fv.disableSubmitButtons(true);});var b=function(h,g){var d=$("#TablaAcceso").dataTable();
var f=0;var e="";if(h&&g){$(d.fnGetNodes()).each(function(l){var j=d.fnGetPosition(this);var k=d.fnGetData(j[0]);if(k[l]["id_tipo_modulo_id_modulo"]==h){if(k[l]["id_poder"]==1){f=1;
}else{$.each(g,function(i,m){if(m==k[l]["id_poder"]){e=k[l]["des_poder"];f=2;}});}}});}switch(f){case 1:return{valid:false,message:"Verifique ya posee todos los poderes"};
case 2:return{valid:false,message:"Verifique ya posee "+e+" para este módulo"};break;default:return true;}};TablaSeleccionRegitro("TablaPerfil","id_usuario_acceso");
$(document).on("click","#agregar",agregarRol);$(document).on("click","#AgregarAcceso",AgregarAcceso);$(document).on("click","#consultar",consultarUsuario);
TablaAccesos([]);});